<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Literature.exe</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
html {
    height: 100%;
    background: url("Club.png") no-repeat center center fixed;
    background-size: cover;
}
body {
    margin: 0;
    font-family: monospace;
    color: white;
}
#overlay {
    background: rgba(0,0,0,0.25);
    min-height: 100vh;
    display: flex;
}

/* Classement gauche */
#leaderboardPanel {
    width: 260px;
    background: rgba(0,0,0,0.9);
    padding: 10px;
    transition: transform 0.3s ease;
}
#leaderboardPanel.hidden { transform: translateX(-240px); }
#toggleLeaderboard {
    cursor: pointer;
    color: #ff6fa9;
    text-align: right;
    font-size: 14px;
}

/* Centre */
#main {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    padding: 20px;
}
#logo {
    max-width: 380px;
    cursor: pointer;
    user-select: none;
}
.bounce { animation: bounce 0.25s ease; }
@keyframes bounce { 0%{scale:1}40%{scale:0.95}100%{scale:1} }

/* Boutique droite */
#shop {
    width: 300px;
    background: rgba(0,0,0,0.9);
    padding: 15px;
    overflow-y: auto;
}

/* Stats bas gauche */
#statsBar {
    position: fixed;
    bottom: 10px;
    left: 10px;
    background: rgba(0,0,0,0.85);
    padding: 10px 15px;
    font-size: 14px;
    border: 1px solid #ff6fa9;
    min-width: 180px;
    max-width: 300px;
    transition: width 0.3s ease, padding 0.3s ease;
}
h2 { color: #ff6fa9; text-align: center; }
.upgrade { border: 1px solid #444; padding: 10px; margin-bottom: 10px; }
button { background: #1a1a1a; color: white; border: 1px solid #ff6fa9; padding: 8px 16px; cursor: pointer; }
button:hover { background: #ff6fa9; color: black; }
#leaderboard li { font-size: 14px; margin-bottom: 5px; }
</style>
</head>

<body>

<!-- Audio -->
<audio id="music" loop>
    <source src="audio/Doki Doki Literature Club! OST - Doki Doki Literature Club! (Main Theme).mp3" type="audio/mpeg">
</audio>
<audio id="clickSound">
    <source src="audio/computer-mouse-click-351398.mp3" type="audio/mpeg">
</audio>

<div id="overlay">
<div id="leaderboardPanel">
    <div id="toggleLeaderboard" onclick="toggleLeaderboard()">â‰ª</div>
    <h2>Classement</h2>
    <ol id="leaderboard"></ol>
</div>

<div id="main">
    <img id="logo"
         src="https://vignette.wikia.nocookie.net/doki-doki-literature-club/images/c/c9/Logo.png/revision/latest?cb=20171204125056"
         onclick="clickLiterature()">
    <p style="opacity:0.6;">Clique sur le logo</p>
</div>

<div id="shop">
    <h2>Boutique</h2>
    <div id="shopItems"></div>
</div>
</div>

<div id="statsBar">
    <div id="points">Points : 0</div>
    <div id="stats">Par clic : 1 | Auto : 0 / sec</div>
</div>

<script>
// ðŸ”¥ Firebase
firebase.initializeApp({
  apiKey: "AIzaSyCugkmIHQfG527QDYEmeylRb-8yNBE-Qk0",
  authDomain: "dokidokilitteratureclub-61b4c.firebaseapp.com",
  projectId: "dokidokilitteratureclub-61b4c"
});
const db = firebase.firestore();

// ðŸ‘¤ Joueur
let playerName = localStorage.getItem("ddlc_name");
let password = localStorage.getItem("ddlc_password");
function encodePassword(pwd){ return btoa(pwd); } // simple "hash"

// Si pas de compte
if(!playerName || !password){
    playerName = prompt("Pseudo :");
    password = prompt("Mot de passe :");
    localStorage.setItem("ddlc_name", playerName);
    localStorage.setItem("ddlc_password", password);
}
let encodedPwd = encodePassword(password);

// ðŸŽ® Stats
let points=0, perClick=1, passive=0, totalPointsGained=0, purchaseBonus=0;
let clickTimes=[], musicStarted=false, lastSentScore=0;

// ðŸ›’ Upgrades
const upgrades=[
  { name:"âœ’ï¸ Stylo", cost:50, perClick:1, passive:0, bonus:0.1 },
  { name:"ðŸ““ PoÃ¨me", cost:250, perClick:5, passive:0, bonus:0.2 },
  { name:"ðŸ’¾ Fichier .chr", cost:500, perClick:0, passive:2, bonus:0.5 }
];

// ðŸ”„ Charger compte
db.collection("players").doc(playerName).get().then(doc=>{
    if(doc.exists && doc.data().password === encodedPwd){
        points=doc.data().points;
        perClick=doc.data().perClick;
        passive=doc.data().passive;
        totalPointsGained=doc.data().totalPointsGained || points;
        purchaseBonus=doc.data().purchaseBonus || 0;
        updateUI();
    } else { savePlayerData(); }
}).catch(()=>{
    const backup=JSON.parse(localStorage.getItem("ddlc_backup"));
    if(backup){
        points=backup.points;
        perClick=backup.perClick;
        passive=backup.passive;
        totalPointsGained=backup.totalPointsGained||points;
        purchaseBonus=backup.purchaseBonus||0;
        updateUI();
    }
});

// UI
function updateUI(){
    document.getElementById("points").innerText="Points : "+Math.floor(points);
    document.getElementById("stats").innerText=`Par clic : ${perClick} | Auto : ${passive} / sec`;
    // Ajuste la largeur de la barre selon la longueur
    const statsBar=document.getElementById("statsBar");
    statsBar.style.width=Math.min(300, 180+Math.floor(document.getElementById("points").innerText.length*6))+"px";
}

// Anti auto-clic + bounce + son + musique
function clickLiterature(){
    const logo=document.getElementById("logo");
    const clickSound=document.getElementById("clickSound");
    const music=document.getElementById("music");

    logo.classList.remove("bounce"); void logo.offsetWidth; logo.classList.add("bounce");
    clickSound.currentTime=0; clickSound.play();
    if(!musicStarted){ music.volume=0.5; music.play(); musicStarted=true; }

    const now=Date.now();
    clickTimes.push(now);
    clickTimes=clickTimes.filter(t=>now-t<1000);

    let gain=perClick;
    if(clickTimes.length>12) gain*=0.2;
    if(clickTimes.length>20) gain=0;

    points+=gain;
    totalPointsGained+=gain;
    updateUI();
}

// Boutique
function renderShop(){
    const shop=document.getElementById("shopItems");
    upgrades.forEach(up=>{
        const div=document.createElement("div");
        div.className="upgrade";
        div.innerHTML=`
            <strong>${up.name}</strong><br>
            +${up.perClick} clic<br>
            +${up.passive} sec<br>
            CoÃ»t : ${up.cost}<br><br>
            <button onclick='buyUpgrade(${JSON.stringify(up)})'>Acheter</button>
        `;
        shop.appendChild(div);
    });
}
function buyUpgrade(up){
    if(points>=up.cost){
        points-=up.cost;
        perClick+=up.perClick;
        passive+=up.passive;
        purchaseBonus+=up.bonus;
        updateUI();
        savePlayerData();
    }
}

// Passif
setInterval(()=>{
    points+=passive;
    totalPointsGained+=passive;
    if(passive>0) updateUI();
},1000);

// Sauvegarde Firestore + local
function savePlayerData(){
    db.collection("players").doc(playerName).set({
        password: encodedPwd,
        points: Math.floor(points),
        perClick,
        passive,
        totalPointsGained,
        purchaseBonus,
        time: Date.now()
    });
    localStorage.setItem("ddlc_backup", JSON.stringify({points, perClick, passive, totalPointsGained, purchaseBonus}));
}

// Score calculÃ©
function getScore(){
    return totalPointsGained/1000 + purchaseBonus;
}

// Classement
function loadLeaderboard(){
    db.collection("players")
      .orderBy("points","desc") // tri par points gagnÃ©s + bonus
      .limit(15)
      .onSnapshot(snapshot=>{
          const list=document.getElementById("leaderboard");
          list.innerHTML="";
          snapshot.forEach(doc=>{
              const data=doc.data();
              const score=(data.totalPointsGained/1000)+(data.purchaseBonus||0);
              list.innerHTML+=`<li>${doc.id} â€” ${score.toFixed(2)}</li>`;
          });
      });
}

// Toggle leaderboard
function toggleLeaderboard(){
    document.getElementById("leaderboardPanel").classList.toggle("hidden");
}

window.addEventListener("beforeunload", savePlayerData);

// Init
renderShop();
loadLeaderboard();
updateUI();
</script>

</body>
</html>
